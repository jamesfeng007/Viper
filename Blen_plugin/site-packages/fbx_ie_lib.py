'''
Created on

@author: James
'''

import ctypes
import os.path

dll_name = "FBXUtil.dll"
dllabspath = os.path.dirname(os.path.abspath(__file__)) + os.path.sep + dll_name
lib = ctypes.cdll.LoadLibrary(dllabspath)

ChannelType = {
    'T_X':0,
    'T_Y':1,
    'T_Z':2,
    'R_X':3,
    'R_Y':4,
    'R_Z':5,
    'S_X':6,
    'S_Y':7,
    'S_Z':8,
}

class Vector3(ctypes.Structure):
    def __init__(self, vx, vy, vz):
        self.x = vx
        self.y = vy
        self.z = vz
        
    _fields_ = [
        ("x", ctypes.c_float),
        ("y", ctypes.c_float),
        ("z", ctypes.c_float)]
    
class Vector4(ctypes.Structure):
    def __init__(self, vx, vy, vz, vw):
        self.x = vx
        self.y = vy
        self.z = vz
        self.w = vw
        
    _fields_ = [
        ("x", ctypes.c_float),
        ("y", ctypes.c_float),
        ("z", ctypes.c_float),
        ("w", ctypes.c_float)]    
    
class Mat4x4(ctypes.Structure):
    def __init__(self, x0, x1, x2, x3, y0, y1, y2, y3, z0, z1, z2, z3, w0, w1, w2, w3):
        self.x0 = x0
        self.x1 = x1
        self.x2 = x2
        self.x3 = x3
        self.y0 = y0
        self.y1 = y1
        self.y2 = y2
        self.y3 = y3
        self.z0 = z0
        self.z1 = z1
        self.z2 = z2
        self.z3 = z3
        self.w0 = w0
        self.w1 = w1
        self.w2 = w2
        self.w3 = w3
        
    _fields_ = [
        ("x0", ctypes.c_float), ("x1", ctypes.c_float), ("x2", ctypes.c_float), ("x3", ctypes.c_float),
        ("y0", ctypes.c_float), ("y1", ctypes.c_float), ("y2", ctypes.c_float), ("y3", ctypes.c_float),
        ("z0", ctypes.c_float), ("z1", ctypes.c_float), ("z2", ctypes.c_float), ("z3", ctypes.c_float),
        ("w0", ctypes.c_float), ("w1", ctypes.c_float), ("w2", ctypes.c_float), ("w3", ctypes.c_float)]

class FBXExport(object):
    def __init__(self, val):
        lib.Exporter_new.argtypes = []
        lib.Exporter_new.restype = ctypes.c_void_p
        
        lib.Exporter_AddVertex.argtypes = [ctypes.c_void_p, ctypes.c_float, ctypes.c_float, ctypes.c_float]
        lib.Exporter_AddVertex.restype = ctypes.c_void_p
        
        lib.Exporter_AddNormal.argtypes = [ctypes.c_void_p, ctypes.c_float, ctypes.c_float, ctypes.c_float]
        lib.Exporter_AddNormal.restype = ctypes.c_void_p
        
        lib.Exporter_AddUV.argtypes = [ctypes.c_void_p, ctypes.c_int, ctypes.c_float, ctypes.c_float]
        lib.Exporter_AddUV.restype = ctypes.c_void_p
        
        lib.Exporter_AddIndex.argtypes = [ctypes.c_void_p, ctypes.c_int]
        lib.Exporter_AddIndex.restype = ctypes.c_void_p
        
        lib.Exporter_AddMeshEdge.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_int, ctypes.c_int]
        lib.Exporter_AddMeshEdge.restype = ctypes.c_void_p        
        
        lib.Exporter_AddMatIndex.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_int]
        lib.Exporter_AddMatIndex.restype = ctypes.c_void_p
        
        lib.Exporter_AddTangent.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.POINTER(Vector3)]
        lib.Exporter_AddTangent.restype = ctypes.c_void_p
        
        lib.Exporter_AddBinormal.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.POINTER(Vector3)]
        lib.Exporter_AddBinormal.restype = ctypes.c_void_p
        
        lib.Exporter_SetTangentName.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p]
        lib.Exporter_SetTangentName.restype = ctypes.c_void_p
        
        lib.Exporter_SetBinormalName.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p]
        lib.Exporter_SetBinormalName.restype = ctypes.c_void_p        
        
        lib.Exporter_AddUVIndex.argtypes = [ctypes.c_void_p, ctypes.c_int, ctypes.c_int]
        lib.Exporter_AddUVIndex.restype = ctypes.c_void_p        
        
        lib.Exporter_AddLoopStart.argtypes = [ctypes.c_void_p, ctypes.c_int]
        lib.Exporter_AddLoopStart.restype = ctypes.c_void_p
        
        lib.Exporter_AddSmoothing.argtypes = [ctypes.c_void_p, ctypes.c_int]
        lib.Exporter_AddSmoothing.restype = ctypes.c_void_p
        
        lib.Exporter_SetSmoothMode.argtypes = [ctypes.c_void_p, ctypes.c_int]
        lib.Exporter_SetSmoothMode.restype = ctypes.c_void_p
        
        lib.Exporter_SetMeshProperty.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.POINTER(Vector3), ctypes.POINTER(Vector3), ctypes.POINTER(Vector3)]
        lib.Exporter_SetMeshProperty.restype = ctypes.c_void_p
        
        lib.Exporter_AddBone.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.POINTER(Vector3), ctypes.POINTER(Vector3), ctypes.POINTER(Vector3)]
        lib.Exporter_AddBone.restype = ctypes.c_void_p
        
        lib.Exporter_AddMaterial.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.POINTER(Vector3), ctypes.POINTER(Vector3), ctypes.POINTER(Vector3)]
        lib.Exporter_AddMaterial.restype = ctypes.c_void_p
        
        lib.Exporter_AddTexture.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_int, ctypes.c_bool, ctypes.c_int, ctypes.c_char_p, 
                                       ctypes.c_int, ctypes.c_int, ctypes.POINTER(Vector3), ctypes.POINTER(Vector3), ctypes.c_bool, ctypes.c_bool]
        lib.Exporter_AddTexture.restype = ctypes.c_void_p
        
        lib.Exporter_SetTextureMatProp.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_char_p]
        lib.Exporter_SetTextureMatProp.restype = ctypes.c_void_p        
        
        lib.Exporter_AddPoseNode.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.POINTER(Mat4x4)]
        lib.Exporter_AddPoseNode.restype = ctypes.c_void_p
        
        lib.Exporter_AddBoneChild.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p]
        lib.Exporter_AddBoneChild.restype = ctypes.c_void_p
        
        lib.Exporter_AddSubDeformerIndex.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_int]
        lib.Exporter_AddSubDeformerIndex.restype = ctypes.c_void_p
        
        lib.Exporter_AddSubDeformerWeight.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_float]
        lib.Exporter_AddSubDeformerWeight.restype = ctypes.c_void_p
        
        lib.Exporter_SetSubDeformerTransform.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.POINTER(Mat4x4), ctypes.POINTER(Vector4)]
        lib.Exporter_SetSubDeformerTransform.restype = ctypes.c_void_p
        
        lib.Exporter_SetSubDeformerTransformLink.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.POINTER(Mat4x4)]
        lib.Exporter_SetSubDeformerTransformLink.restype = ctypes.c_void_p
        
        lib.Exporter_SetChannelDefaultValue.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_int, ctypes.c_double]
        lib.Exporter_SetChannelDefaultValue.restype = ctypes.c_void_p
        
        lib.Exporter_AddChannelKey.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_char_p, ctypes.c_int, ctypes.c_float, ctypes.c_float]
        lib.Exporter_AddChannelKey.restype = ctypes.c_void_p
        
        lib.Exporter_SetTimeSpan.argtypes = [ctypes.c_void_p, ctypes.c_char_p, ctypes.c_float, ctypes.c_float, ctypes.c_float, ctypes.c_float]
        lib.Exporter_SetTimeSpan.restype = ctypes.c_void_p
        
        lib.Exporter_SetFPS.argtypes = [ctypes.c_void_p, ctypes.c_float]
        lib.Exporter_SetFPS.restype = ctypes.c_void_p        
        
        lib.Exporter_CreateUVInfo.argtypes = [ctypes.c_void_p, ctypes.c_int, ctypes.c_char_p]
        lib.Exporter_CreateUVInfo.restype = ctypes.c_void_p
        
        lib.Exporter_Export.argtypes = [ctypes.c_void_p, ctypes.c_char_p]
        lib.Exporter_Export.restype = ctypes.c_bool
        
        lib.Exporter_PrintMesh.argtypes = [ctypes.c_void_p]
        lib.Exporter_PrintMesh.restype = ctypes.c_void_p
        
        lib.Exporter_PrintSkeleton.argtypes = [ctypes.c_void_p]
        lib.Exporter_PrintSkeleton.restype = ctypes.c_void_p
        
        lib.Exporter_PrintTakes.argtypes = [ctypes.c_void_p]
        lib.Exporter_PrintTakes.restype = ctypes.c_void_p
        
        lib.Exporter_SetAsASCII.argtypes = [ctypes.c_void_p, ctypes.c_bool]
        lib.Exporter_SetAsASCII.restype = ctypes.c_void_p        

        self.obj = lib.Exporter_new(val)
    
    def add_vertex(self, px, py, pz):
        lib.Exporter_AddVertex(self.obj, px, py, pz)
        
    def create_uv_info(self, index, name):
        lib.Exporter_CreateUVInfo(self.obj, index, name)
        
    def add_uv(self, unIndex, x, y):
        lib.Exporter_AddUV(self.obj, unIndex, x, y)
        
    def add_uv_index(self, unIndex, index):
        lib.Exporter_AddUVIndex(self.obj, unIndex, index)        
        
    def add_normal(self, nx, ny, nz):
        lib.Exporter_AddNormal(self.obj, nx, ny, nz)
        
    def add_index(self, index):
        lib.Exporter_AddIndex(self.obj, index)
        
    def add_mesh_edge(self, name, sindex, eindex):
        lib.Exporter_AddMeshEdge(self.obj, name, sindex, eindex)        
        
    def add_mat_index(self, name, index):
        lib.Exporter_AddMatIndex(self.obj, name, index)
        
    def add_tangent(self, name, tan):
        lib.Exporter_AddTangent(self.obj, name, tan)
        
    def add_binormal(self, name, bino):
        lib.Exporter_AddBinormal(self.obj, name, bino)
        
    def set_binormal_name(self, name, bino):
        lib.Exporter_SetBinormalName(self.obj, name, bino)
        
    def set_tangent_name(self, name, tan):
        lib.Exporter_SetTangentName(self.obj, name, tan)
        
    def add_smoothing(self, index):
        lib.Exporter_AddSmoothing(self.obj, index)
        
    def set_smoothing_mode(self, index):
        lib.Exporter_SetSmoothMode(self.obj, index)
        
    def add_loop_start(self, start):
        lib.Exporter_AddLoopStart(self.obj, start)
        
    def set_mesh_property(self, name, trans, rot, scale):
        lib.Exporter_SetMeshProperty(self.obj, name, trans, rot, scale)
        
    def add_material(self, mname, sname, diffuse, ambient, emissive):
        lib.Exporter_AddMaterial(self.obj, mname, sname, diffuse, ambient, emissive)
        
    def add_texture(self, name, fileName, relFileName, alphaSource, premultiplyAlpha, currentMappingType, UVSet, 
                    wrapModeU, wrapModeV, translation, scaling, useMaterial, useMipMap):
        lib.Exporter_AddTexture(self.obj, name, fileName, relFileName, alphaSource, premultiplyAlpha, currentMappingType, UVSet, 
                           wrapModeU, wrapModeV, translation, scaling, useMaterial, useMipMap)
        
    def set_texture_mat_prop(self, name, matName, matProp):
        lib.Exporter_SetTextureMatProp(self.obj, name, matName, matProp)        
        
    def add_pose_node(self, name, mat):
        lib.Exporter_AddPoseNode(self.obj, name, mat)
        
    def add_sub_deformer_index(self, mname, bname, index):
        lib.Exporter_AddSubDeformerIndex(self.obj, mname, bname, index)
        
    def add_sub_deformer_weight(self, mname, bname, weight):
        lib.Exporter_AddSubDeformerWeight(self.obj, mname, bname, weight)
        
    def set_sub_deformer_transform(self, mname, bname, transf, quat):
        lib.Exporter_SetSubDeformerTransform(self.obj, mname, bname, transf, quat)
        
    def set_sub_deformer_transform_link(self, mname, bname, transfLink):
        lib.Exporter_SetSubDeformerTransformLink(self.obj, mname, bname, transfLink)
        
    def set_channel_default_value(self, tname, mname, type, value):
        lib.Exporter_SetChannelDefaultValue(self.obj, tname, mname, type, value)
        
    def add_channel_key(self, tname, mname, type, frame, value):
        lib.Exporter_AddChannelKey(self.obj, tname, mname, type, frame, value)
        
    def set_time_span(self, tname, lstart, lend, rstart, rend):
        lib.Exporter_SetTimeSpan(self.obj, tname, lstart, lend, rstart, rend)
        
    def set_fps(self, fps):
        lib.Exporter_SetFPS(self.obj, fps)        
        
    def add_bone_child(self, cname, pname):
        lib.Exporter_AddBoneChild(self.obj, cname, pname)        
        
    def add_bone(self, name, translation, rotation, scaling):
        lib.Exporter_AddBone(self.obj, name, translation, rotation, scaling)
        
    def export(self, filename):
        lib.Exporter_Export(self.obj, filename)
        
    def print_mesh(self):
        lib.Exporter_PrintMesh(self.obj)
        
    def print_skeleton(self):
        lib.Exporter_PrintSkeleton(self.obj)
        
    def print_takes(self):
        lib.Exporter_PrintTakes(self.obj)
        
    def set_as_ascii(self, asAscii):
        lib.Exporter_SetAsASCII(self.obj, asAscii)        
        